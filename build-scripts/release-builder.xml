<?xml version="1.0" encoding="UTF-8"?>
<!--
/*******************************************************************************
 * Copyright (c) 2010 Matthew J. Dovey (www.ceridwen.com).
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the GNU Public License v3.0
 * which accompanies this distribution, and is available at 
 * <http://www.gnu.org/licenses/>
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>. 
 -->

<!-- Build script module for recording the release into subversion -->

<!-- *************************************************************** -->
<!--   Set-Up of SVN-ANT classpath                                   -->
<!-- *************************************************************** -->  



<project>
    <path id="path.svnant">
        <pathelement location="${ant.library.dir}/svnant.jar"/>
        <pathelement location="${ant.library.dir}/svnClientAdapter.jar"/>
    </path>

	<typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="path.svnant" />

	<target name="tool-availability">
		<available resource="org/tigris/subversion/svnant/svnantlib.xml"
			classpathref="path.svnant"
			property="available.svnant"
	 	/>
	  	<echo message="SVN-ANT is available = ${available.svnant}"/>
	</target>

	<target name="does-svnant-exist" depends="tool-availability">
		<fail unless="available.svnant">
	  		SVN-ANT is not available, cannot perform tagging
	 	</fail>  
	</target>
	
	<target name="svntag" depends="does-svnant-exist" description="tags individual project using svnant task">    
		<property name="svn.tag.message" value="Release ${env.bamboo_jira_version} build initiated from Jira by ${env.bamboo_jira_username}"/>
		<property name="src.path"  value="${basedir}"/>
		<property name="dest.url" value="${bamboo.repository.svn.repositoryUrl}/../tags/RELEASE - ${env.bamboo_jira_version}"/>

		<svn>
	 		<copy srcPath="${src.path}" destUrl="${dest.url}" message="${svn.tag.message}"/>    
	 	</svn>
	</target>	
	
	<property environment="env" />
  	<import file="version-builder.xml"/>
	
  	<target name="record-release" depends="stamp-build" if="env.bamboo_jira_version">
  		<fail message="Version mismatch: Jira reports ${env.bamboo_jira_version} whilst build-data.properties reports ${implementation-short-version}">
	  		<condition>
  	  			<not>
		  		    <equals arg1="${env.bamboo_jira_version}" arg2="${implementation-short-version}"/>
    			</not>
	  		</condition>
  		</fail>
  		
  		<echo message="${bamboo.repository.svn.repositoryUrl}" />
  		
  		<antcall target="svntag" /> 
  	</target>
</project>
